# Bridging SBI and NGAP: Implementing AMF CreateUEContext Service
In this article, we will introduce the Create UE Context service in Access and Mobility Management Function (AMF), and explain the implementation in free5GC.

### Create UE Context service
##### When is this service used?
This service operation is used by a source AMF (S-AMF) to create the UE context in a target AMF (T-AMF) during handover procedures.\[1]

##### What does the target AMF do in the procedure?
![[N2 Handover preparation phase procedure T-AMF perspective.png]]
After receiving the **Create UE Context** request, the T-AMF
1. Sets `hoState` to `PREPARING` via an **Update SM Context** Request for the PDU sessions being handed over.\[2]
2. Send **Handover Request** to reserve resources at T-RAN.\[3]
3. Sets `hoState` to `PREPARED` via another **Update SM Context** Request.\[2]
4. Send **Create UE Context** Response to S-AMF.

The **Handover Request** and **Handover Request Acknowledge** are NGAP messages carried over SCTP, rather than the HTTP/HTTPS used on the Service-Based Interface (SBI).

### How does free5GCâ€™s AMF handle messages?
![[AmfApp structure for ngap service and sbi server 1.png]]
In free5GC, the NGAP service and the SBI server listen on different ports. In other words, the Create UE Context Request is processed in a Goroutine spawned by the SBI server, while the NGAP service handles the Handover Request Acknowledge in a separate Goroutine.

### Implementation of Create UE Context processor
![[PendingHandovers sync.Map in AMFContext.png]]
Channels of Response model type are added to pass the response message from the NGAP handler to the SBI processor.

![[Send HORequest and wait for CreUECtx Response in ue_context.go.png]]
The `CreateUEContextProcedure` processor sends a `HandoverRequest` message to the T-RAN, then waits for the Handover Request Acknowledge handler to prepare the `createUeContextResponse` and deliver it through the channel back to the SBI processor.

![[Pass CreUECtx Response to processor.png]]
The `handleHandoverRequestAcknowledgeMain()` verifies whether resource allocation for any PDU session succeeded; If so, it builds the `CreateUeContextResponse` and passes it to the SBI processor.

### Reference
- \[1\] [TS 23.502 - V17.12.0; Procedures for the 5G System (5GS)](https://www.etsi.org/deliver/etsi_ts/123500_123599/123502/17.12.00_60/ts_123502v171200p.pdf) 
- \[2\] [TS 29.502 - V17.10.0; Session Management Services](https://www.etsi.org/deliver/etsi_ts/129500_129599/129502/17.10.00_60/ts_129502v171000p.pdf) 
- \[3\] [TS 38.413 - V17.10.0; NG Application Protocol (NGAP)](https://www.etsi.org/deliver/etsi_ts/138400_138499/138413/17.10.00_60/ts_138413v171000p.pdf) 
